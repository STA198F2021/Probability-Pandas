---
title: "Final Report"
subtitle: "due November 16, 2021 by 11:59 PM "
author: "Enzo, Layla, Madeleine"
date: "November 16, 2021"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r load-packages-data, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(tidyr)
library(dplyr)
library(plyr)
library(tidymodels)
library(infer)
library(readr)
library(ggplot2)
library(sf)
library(plotly)
library(tab)
library(pROC)
library(sjPlot)
library(sjlabelled)
library(sjmisc)
library(kableExtra)
library(gtsummary)
library(repr)
library(gridExtra)
library(xtable)
library(knitr)
initial_data <- read_csv("../data/500_Cities.csv")
options(scipen=10000)

usa <- map_data('usa')
state <- map_data("state")
```

```{r data-wrangling, warning=FALSE, message=FALSE, echo=FALSE}
cities <- initial_data %>%
  select(StateAbbr, PlaceName, Population2010, PlaceFIPS, Geolocation, 
         ACCESS2_AdjPrev,CANCER_AdjPrev, CHD_AdjPrev, CHECKUP_AdjPrev,
         COPD_AdjPrev, COLON_SCREEN_AdjPrev,COREM_AdjPrev, COREW_AdjPrev, 
         KIDNEY_AdjPrev, MAMMOUSE_AdjPrev, PAPTEST_AdjPrev) %>%
  dplyr::rename(state = StateAbbr, city = PlaceName, population = Population2010,
         health_access = ACCESS2_AdjPrev, cancer = CANCER_AdjPrev,
         heart_disease = CHD_AdjPrev, checkup = CHECKUP_AdjPrev,
         chronic_lung_disease = COPD_AdjPrev,
         colon_screen = COLON_SCREEN_AdjPrev,
         men_colorectal_cancer_screen = COREM_AdjPrev,
         women_colorectal_cancer_screen = COREW_AdjPrev,
         chronic_kidney_disease = KIDNEY_AdjPrev,
         mammogram = MAMMOUSE_AdjPrev,
         pap_test = PAPTEST_AdjPrev) %>%
  mutate(large_metro = (population >= 1500000), 
         metro = (population >= 500000 & population < 1500000), 
         med_urban = (population >= 200000 & population < 500000), 
         small_urban = (population >= 50000 & population < 200000)) %>%
  mutate(west = (state %in% c("WA", "OR", "ID", "MT", "WY", "CA", "NV", "UT", 
                              "CO", "AZ", "NM")), 
         midwest = (state %in% c("ND", "SD", "NE", "KS", "MN", "IA", "MO", 
                                 "WI", "IL", "IN", "MI", "OH")),
         northeast = (state %in% c("PA", "NY", "VT", "NH", "MA", "CT", "RI", 
                                   "NJ", "ME", "DC")), 
         south = (state %in% c("OK", "TX", "AR", "LA", "MS", "AL", "TN", "KY", 
                               "WV", "VA", "MD", "DE", "NC", "SC", "GA", 
                               "FL"))) %>%
  mutate(region = ifelse(west == TRUE, "West", 
                         ifelse(midwest == TRUE, "Midwest", 
                                ifelse(northeast == TRUE, "Northeast", 
                                       ifelse(south == TRUE,  
                                              "South", NA))))) %>%
  mutate(city_size = ifelse(large_metro == TRUE, "Large Metropolitan", 
                         ifelse(metro == TRUE, "Metropolitan", 
                                ifelse(med_urban == TRUE, "Medium-Size Urban", 
                                       ifelse(small_urban == TRUE, 
                                              "Small-Size Urban", NA))))) %>%
  na.omit(city_size) %>%
  na.omit(region) %>%
  mutate(checkup_n = (population*(checkup/100)), 
         colon_n_screened = (population*(colon_screen/100)), 
         m_colorectal_n_screened = (population*(men_colorectal_cancer_screen/100)),
         w_colorectal_n_screened = 
           (population*(women_colorectal_cancer_screen/100)),
         mammogram_n_screened = (population*(mammogram/100)),
         pap_n_screened = (population*(pap_test/100))) %>%
  mutate(no_checkup_n = (population - checkup_n), 
         no_colon_n_screened = (population - colon_n_screened), 
         no_m_colorectal_n_screened = (population - m_colorectal_n_screened),
         no_w_colorectal_n_screened = 
           (population - w_colorectal_n_screened),
         no_mammogram_n_screened = (population - mammogram_n_screened),
         no_pap_n_screened = (population - pap_n_screened))

#this is the training data set called model_cities
set.seed(100)

split <- initial_split(cities, prop = 3/4, strata = region)

model_cities <- training(split)
cities_test <- testing(split)

#for introductory visualizations
west_cities <- cities %>%
  filter(west)

midwest_cities <- cities %>%
  filter(midwest)

northeast_cities <- cities %>%
  filter(northeast)

south_cities <- cities %>%
  filter(south)

``` 
# Introduction
We have analyzed the 500 Cities Project: 2016 - 2019, collectd by the Centers of Disease Control and Prevention (CDC), Division of Population Health, Epidemiology and Surveillance Branch. The Robert Wood Johnson Foundation (RWJF) and the CDC Foundation funded this project. 

In this database, the CDC provides information about the 500 largest cities in the United
States. There are 500 observations in this dataset, each correlating to one unique city. Some of the prominent variables in this dataset include crude and adjusted rates of the lack of access to insurance, prevalence of various chronic illnesses, prevalence of routine doctor visits, and prevalence of chronic illness tests/screenings. The chronic illnesses include, but are not limited to, cancer, coronary heart disease, obstructive pulmonary disease, and kidney disease. 

It includes variables such as lack of healthcare access, prevalence of checkups, and prevalence of various chronic diseases as well as various screening tests. The lack of healthcare access is a key variable as we will use this variable to observe how it affects the numbers of screenings. Having a low percentage of the lack of healthcare variable would indicate that a city has high access to healthcare and inversely, having a high percentage of the lack of healthcare variable would indicate that a city has little access to healthcare. 

Receiving screening for various chronic diseases can reduce mortality rates for those diseases. For example, the American Cancer society conducted a study to observe the effects of mammogram screenings on the prevalence of advanced and fatal breast cancers. The study found that women who received breast cancer screening had a statistically significant 41% reduction in their risk of having a fatal breast cancer case and a 25% reduction in the rates of advanced breast cancer. This study suggests that receiving a screening can decrease the likelihood of having a fatal or worsened case of breast cancer. Furthermore, a different study examined the mortality of colorectal cancer patients based on whether or not they had received a colonoscopy. The study concluded that those who received a colonoscopy had lower rates of experiencing death due to colon cancer than those who did not receive a colonoscopy. A similar study also concluded that fecal occult blood testing reduced colorectal cancer rates by 16%. Another 2014 study examined a 28% risk reduction in colorectal cancer mortality due to sigmoidoscopy screening. One 2007 study recorded the decline in cervical cancer due to the implementation of a papanicolaou test screening program. These various studies suggest that screening for various chronic diseases may effectively reduce mortality rates for each disease. 

# Research Question
How does health insurance correlate to the prevalence of screening for various chronic diseases? 

| The goal of this report is to analyze how health insurance affects people’s access to chronic disease screening. We hypothesized that decreased lack of health insurance is correlated to increased screening for chronic diseases in various cities. Inversely, we also hypothesized that increased lack of health insurance prevalence is correlated to decreased screening for chronic diseases in various cities. 

Null Hypothesis: The lack of health insurance has no effect on the number of chronic disease screenings in various cities. 

Alternative Hypothesis:  The lack of health insurance has an effect on the number of chronic disease screenings in various cities. 

# Data Wrangling

We first selected to only use the columns in the dataset indicating state, city name, population, lack of access to health care, different prevalence of chronic diseases and screening for chronic diseases. After renaming them accordingly we categorized each city into regions: West, Midwest, North, and South through the definitions given by the US Census. We also categorized them by city size: large metropolitan, if they had a population of 1.5 million or more, metropolitan if their population was between 500,000 and 1.5 million, medium-size urban, if their population was between 200,000 and 500,000, and small urban, if their population was between 50,000 and 200,000. We also omitted any cities that did not fit into any region or city size categories. These sizing categories were given by the OECD. Then we created two new columns that calculated the number of individuals in each city who got an annual checkup and the number of individuals who did not get an annual checkup. Lastly, to create a model we split the entire data set into two sets, ¾ of the set becoming the training data being used for creating the model and ¼ of the data being set aside to test the model against. 

# Introductory Visualisations of Data Set

```{r correlation-table, warning=FALSE, message=FALSE, echo=FALSE}
correlation1 <- cor.test(cities$checkup_n, cities$pap_n_screened,
                         method = "pearson")
tidy.cor1 <- tidy(correlation1) %>%
  rename("Correlation Coefficient Estimate" = estimate, "P-Value" = p.value, 
         "CI Low" = conf.low, "CI High" = conf.high)
tidy.cor1.final <- tidy.cor1[,-c(2,4,7,8)]
kable(tidy.cor1.final, caption = "Pearson's Correlation Test: Pap Tests and Checkups") %>%
    row_spec(0, bold = T) %>%
  kable_styling(latex_options = "HOLD_position")

correlation2 <- cor.test(cities$checkup_n, cities$colon_n_screened,
                         method = "pearson")
tidy.cor2 <- tidy(correlation2) %>%
  rename("Correlation Coefficient Estimate" = estimate, "P-Value" = p.value, 
         "CI Low" = conf.low, "CI High" = conf.high)
tidy.cor2.final <- tidy.cor2[,-c(2,4,7,8)]
kable(tidy.cor2.final, caption = "Pearson's Correlation Test: Colon Screenings and Checkups") %>%
    row_spec(0, bold = T) %>%
  kable_styling(latex_options = "HOLD_position")

correlation3 <- cor.test(cities$checkup_n, cities$mammogram_n_screened,
                         method = "pearson")
tidy.cor3 <- tidy(correlation3) %>%
    rename("Correlation Coefficient Estimate" = estimate, "P-Value" = p.value, 
         "CI Low" = conf.low, "CI High" = conf.high)
tidy.cor3.final <- tidy.cor3[,-c(2,4,7,8)]
kable(tidy.cor3.final, caption = "Pearson's Correlation Test: Mammograms and Checkups") %>%
    row_spec(0, bold = T) %>%
  kable_styling(latex_options = "HOLD_position")
```

```{r Intro-Visualiszations, warning=FALSE, message=FALSE, echo=FALSE}
#wrangling for visualizations
cities2 <- cities %>%
  filter( region != "NA") %>%
  mutate(logcheckup_n = log(checkup_n))
```

```{r Simple-Marginal-Relationship1, warning=FALSE, message=FALSE, echo=FALSE}
#(1) boxplots of checkup (n and log) by region

plot1 <- ggplot(data = cities2,
       aes(x = region, y = logcheckup_n,
           color = region)) +
  geom_boxplot() +
  labs(x = "Region",
       y = "Checkups per capita (log scale)",
       title = "Checkups by Region") +
  theme(axis.text.x = element_text(angle = 45,hjust=1), legend.position = "none")

```

```{r Simple-Marginal-Relationship2, warning=FALSE, message=FALSE, echo=FALSE}
#(2) histograms showing mean checkup (not that well), faceted by region
plot2 <- cities2 %>%
ggplot(aes(x = logcheckup_n)) +
  facet_wrap(~region) +
  geom_histogram() +
  labs(x = "Checkups per capita (log scale)",
       y = "Count",
       title = "Checkups by Region")
```

```{r arrangeing-plot1/2, warning=FALSE, message=FALSE, echo=FALSE}

grid.arrange(plot1, plot2, ncol = 2)

```


```{r anova1, warning=FALSE, message=FALSE, echo=FALSE}
#(3) anova shows means of checkup (n and log) are different among the regions
anova1 <- aov(logcheckup_n ~ region, data = cities2)
tidy.anova1 <- tidy(anova1) %>%
      rename("Term" = term, "Statistic" = statistic, "P-Value" = p.value)
tidy.anova1.final <- tidy.anova1[-c(2),-c(2,3,4)]
kable(tidy.anova1.final, caption = "ANOVA: Checkups per capita (log scale), by Region") %>%
      row_spec(0, bold = T) %>%
  kable_styling(latex_options = "HOLD_position")
```

```{r Simple-Marginal-Relationship4, warning=FALSE, message=FALSE, echo=FALSE}
#(4) boxplots of checkup (n and log) by city size
plot3 <- ggplot(data = cities2,
       aes(x = city_size, y = logcheckup_n,
           color = city_size)) +
  geom_boxplot() +
  labs(x = "City Size",
       y = "Checkups per capita (log scale)",
       title = "Checkups by City Size") +
  theme(axis.text.x = element_text(angle = 45,hjust=1), legend.position = "none")
```


```{r Simple-Marginal-Relationship5, warning=FALSE, message=FALSE, echo=FALSE}
#(5) histograms showing mean checkup, faceted by city size
plot4 <- cities2 %>%
ggplot(aes(x = logcheckup_n)) +
  facet_wrap(~city_size) +
  geom_histogram() +
  labs(x = "Checkups per capita (log scale)",
       y = "Count",
       title = "Checkups by City Size")
```

```{r arrangeing-plot4/3, warning=FALSE, message=FALSE, echo=FALSE}

grid.arrange(plot3, plot4, ncol = 2)

```

```{r anova2, warning=FALSE, message=FALSE, echo=FALSE}
#(6) anova shows means of checkup (n and log) are different among the city sizes
anova2 <- aov(logcheckup_n ~ city_size, data = cities2)
tidy.anova2 <- tidy(anova2) %>%
        rename("Term" = term, "Statistic" = statistic, "P-Value" = p.value)
tidy.anova2.final <- tidy.anova2[,-c(2,3,4)]
kable(tidy.anova2.final, caption = "ANOVA: Checkups per capita (log scale), by Region") %>%
      row_spec(0, bold = T) %>%
  kable_styling(latex_options = "HOLD_position")
```

```{r introvis-checkup8-lackHC, warning=FALSE, message=FALSE, echo=FALSE, fig.dim= c(6,4)}
ggplot(cities, aes(x = health_access,
                   y= checkup))+
  geom_point()+ 
  labs( x = "Lack of Health Care Access", 
        y = "Checkups Count",
        title = "Prevalence of Checkups and Lack of Healthcare Access")

```

# Models

```{r Multiple-Logistic-Regression-Model, warning=FALSE, message=FALSE, echo=FALSE}

#model 1: withouth interaction
checkup_fit <- glm(cbind(checkup_n, no_checkup_n) ~ region + 
                     city_size + health_access, 
                   family = binomial, data = model_cities)
checkup_fit_df1 <- tidy(checkup_fit, exponentiate = TRUE, intercept = TRUE) %>%
  rename(Variable = term, Estimate = estimate, "P-Value" = p.value) %>%
  mutate(Variable = c("Intercept", "Northeast", "South", "West",
                                  "Medium-Size Urban", "Metropolitan",
                                  "Small-Size Urban", "HC"))
checkup_fit_df1_f <- checkup_fit_df1[, -c(3, 4)]

#model 2: with interaction
checkup_fit2 <- glm(cbind(checkup_n, no_checkup_n) ~ region +
                     city_size + health_access + region*city_size +
                      region*health_access + city_size*health_access,
                   family = binomial, data = model_cities) 

checkup_fit_df2 <- tidy(checkup_fit2, exponentiate = TRUE, intercept = TRUE) %>%
  rename(Variable = term, Estimate = estimate, "P-Value" = p.value) %>%
  mutate(Variable = c("Intercept", "Northeast", "South", "West",
                      "Medium-Size Urban", "Metropolitan", "Small-Size Urban", 
                      "HC", "Northeast by Medium-Size Urban", 
                      "South by Medium-Size Urban", 
                      "West by Medium-Size Urban", "Northeast by Metropolitan", 
                      "South by Metropolitan", "West by Metropolitan", 
                      "Northeast by Small-Size Urban", 
                      "South by Small-Size Urban", "West by Small-Size Urban", 
                      "Northeast by HC", "South by HC", "West by HC", 
                      "Medium-Size Urban by HC", "Metropolitan by HC", 
                      "Small-Size Urban by HC"))
checkup_fit_df2_f <- checkup_fit_df2[, -c(3, 4)]

```

```{r model1-table, warning=FALSE, message=FALSE, echo=FALSE}

checkup_fit_df1_f %>%
  kable(caption = "Model 1: Without Interaction") %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  row_spec(0, bold = T) %>%
  kable_styling(latex_options = "HOLD_position")

```

```{r model2-table, warning=FALSE, message=FALSE, echo=FALSE}

checkup_fit_df2_f %>%
  kable(caption = "Model 2: With Interaction") %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  row_spec(0, bold = T) %>%
  kable_styling(latex_options = "HOLD_position")

```

From the introductory exploration of the 500 cities dataset we decided to create two different multiple logistic regression models that represent the effect of multiple predictors on the outcome of prevalence of checkups in a city. A logistic regression model was chosen because we wanted to model the binary outcome of whether or not individuals in a certain city were getting checkups or not. The first model includes the predictor variables region, city size, and prevalence of lack of access to health care (HC). The second model included all the predictor variables from the first model, as well as their interactions with one another, ie. region and city size, region and HC, and city size and HC. 

# Model Validation

```{r model-validation, warning=FALSE, message=FALSE, echo=FALSE}
# predictions from no interaction model 
test_prob1 = predict(checkup_fit, newdata = cities_test, type = "response")

cities_test1 <-
  merge(cities_test, test_prob1, by = "row.names", all.x = TRUE)

# prediction from model with interaction
test_prob2 = predict(checkup_fit2, newdata = cities_test, type = "response")

cities_test2 <-
  merge(cities_test, test_prob2, by = "row.names", all.x = TRUE)

```

```{r rmse-training, warning=FALSE, message=FALSE, echo=FALSE}
#rmse against model/training data set

#model 1
test_prob_model = predict(checkup_fit, newdata = model_cities, type = "response")
model_cities1 <- merge(model_cities, test_prob_model, by = "row.names", all.x = TRUE)

rmse1 <- rmse(model_cities1, truth = (checkup/100), estimate = test_prob_model) %>%
  rename("RMSE" = .metric, "Estimate" = .estimate)
rmse1_f <- rmse1[, c(1, 3)]

#model 2
test_prob_model2 = predict(checkup_fit2, newdata = model_cities, type = "response")
model_cities2 <- merge(model_cities, test_prob_model2, by = "row.names", all.x = TRUE)

rmse2 <- rmse(model_cities2, truth = (checkup/100), estimate = test_prob_model)%>%
  rename("RMSE" = .metric, "Estimate" = .estimate)
rmse2_f <- rmse2[, c(1, 3)]

```

```{r rmse-table1, warning=FALSE, message=FALSE, echo=FALSE}

rmse1_f %>%
  kable(caption = "RMSE of Model 1 Against Traning Dataset")%>%
  row_spec(0, bold = T) %>%
  kable_styling(latex_options = "HOLD_position")

```

```{r rmse-table2, warning=FALSE, message=FALSE, echo=FALSE}

rmse2_f %>%
  kable(caption = "RMSE of Model 2 Against Traning Dataset") %>%
  kable_classic(full_width = F, html_font = "Cambria")%>%
  row_spec(0, bold = T) %>%
  kable_styling(latex_options = "HOLD_position")

```

```{r rmse-test, warning=FALSE, message=FALSE, echo=FALSE}
#calculate root mean standard error of both models against test data set

#model 1
rmse3 <- rmse(cities_test1, truth = (checkup/100), estimate = test_prob1) %>%
  rename("RMSE" = .metric, "Estimate" = .estimate)
rmse3_f <- rmse3[, c(1, 3)]

#model 2
rmse4 <- rmse(cities_test2, truth = (checkup/100), estimate = test_prob2) %>%
  rename("RMSE" = .metric, "Estimate" = .estimate)
rmse4_f <- rmse4[, c(1, 3)]
```

```{r rmse-table3, warning=FALSE, message=FALSE, echo=FALSE}

rmse3_f %>%
  kable(caption = "RMSE of Model 1 Against Test Dataset")%>%
  row_spec(0, bold = T) %>%
  kable_styling(latex_options = "HOLD_position")

```

```{r rmse-table4, warning=FALSE, message=FALSE, echo=FALSE}

rmse4_f %>%
  kable(caption = "RMSE of Model 2 Against Test Dataset")%>%
  row_spec(0, bold = T) %>%
  kable_styling(latex_options = "HOLD_position")

```

Due to the fact that the statistical significance of the predictors from both logistic regression models were almost identical, in order to determine which model was more effective we calculate the root mean squared error for each model against the test data set. The root mean squared error (RMSE) for both models was not too far from their RMSE’s against the model data set indicating that the model is a good fit for the data set. However, the RMSE for the model without predictors had a lower RMSE against the test dataset than the model with predictors, which suggests Model 1, the model without indicators, is the superior model for the data set. 

# Results

Based on the conclusion from the RMSE, we will only be analyzing the outcomes and estimates from Model 1. In Model 1, we found all of the predictor variables and their levels to be statistically significant because their p-values were well below 0.05. The referent in this model is a large-metropolitan city in the Midwest with an HC value of 0. The model also indicates that when all other variables are held constant, the the odds of getting a checkup decrease the most, relative to the referent group, when in the Western region of the US. Meaning any individual living in cities in the West coast of the US are less likely to get annual checkups. The model also shows a slight decrease in the odds of getting a checkup when a city is either Metropolitan or Small-Size Urban, relative to the referent group. In terms of HC, when the prevalence of lack of access to health care increases, the amount of checkups in that city decreases. Therefore, if there were increased access to health care across any type of city, there would be an increase in the amount of checkups in that city. However, although the significance of the predictor is high, the impact of HC on the model odds of getting a checkup are low relative to the other predictors in the model. Cities in the Northeast are shown in the model to have the higher checkups compared to the rest of the groups, including the referent. 	

# Discussion

In summary, people in medium-size urban cities in the Northeast or South are much more likely to get annual checkups than those in the referent group. While those in metropolitan or small-size urban cities in the West are less likely to get annual checkups that those in the referent group. Although, as access to health care increases the likelihood individuals are to get a checkup increases, independent of which specific city they live in. 

Due to the fact that HC does not have a very significant impact on the model, if we added another data set including other possible predictors for checkups we could have added better predictors to our model. We can see evidence for this in the high RMSE of the model against the training set. This dataset is also limited to the 500 largest cities in the US and is not representative of the entire US. However, we can make generalizations about the impact of region, city size, and HC on checkups and other chronic illness screenings. ______ 

Based on our findings we would suggest further research on why cities in the West are less likely to have checkups. This could be stemming from data that is not part of the dataset that we were analyzing or there could be possible policies and infrastructure that prohibits individuals living in large western cities in the US from getting checkups, increasing the likelihood then to get screenings for chronic diseases and receiving preventative treatments.  _______ 
