---
title: "Final Report"
subtitle: "due November 16, 2021 by 11:59 PM "
author: "Enzo, Layla, Madeleine"
date: "November 16, 2021"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r load-packages-data, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(tidymodels)
library(infer)
library(readr)
library(ggplot2)
library(maps)
library(mapdata)
library(sf)
library(plotly)
initial_data <- read_csv("../data/500_Cities.csv")
options(scipen=10000)

usa <- map_data('usa')
state <- map_data("state")

cities <- initial_data %>%
  select(StateAbbr, PlaceName, Population2010, PlaceFIPS, Geolocation, 
         ACCESS2_AdjPrev,CANCER_AdjPrev, CHD_AdjPrev, CHECKUP_AdjPrev,
         COPD_AdjPrev, COLON_SCREEN_AdjPrev,COREM_AdjPrev, COREW_AdjPrev, 
         KIDNEY_AdjPrev, MAMMOUSE_AdjPrev, PAPTEST_AdjPrev) %>%
  rename(state = StateAbbr, city = PlaceName, population = Population2010,
         health_access = ACCESS2_AdjPrev, cancer = CANCER_AdjPrev, 
         heart_disease = CHD_AdjPrev, checkup = CHECKUP_AdjPrev,
         chronic_lung_disease = COPD_AdjPrev, 
         colon_screen = COLON_SCREEN_AdjPrev,
         men_colorectal_cancer_screen = COREM_AdjPrev,
         women_colorectal_cancer_screen = COREW_AdjPrev,
         chronic_kidney_disease = KIDNEY_AdjPrev,
         mammogram = MAMMOUSE_AdjPrev, 
         pap_test = PAPTEST_AdjPrev) %>%
  mutate(large_metro = (population >= 1500000), 
         metro = (population >= 500000 & population < 1500000), 
         med_urban = (population >= 200000 & population < 500000), 
         small_urban = (population >= 50000 & population < 200000)) %>%
  mutate(west = (state %in% c("WA", "OR", "ID", "MT", "WY", "CA", "NV", "UT", 
                              "CO", "AZ", "NM")), 
         midwest = (state %in% c("ND", "SD", "NE", "KS", "MN", "IA", "MO", 
                                 "WI", "IL", "IN", "MI", "OH")),
         northeast = (state %in% c("PA", "NY", "VT", "NH", "MA", "CT", "RI", 
                                   "NJ", "ME")), 
         south = (state %in% c("OK", "TX", "AR", "LA", "MS", "AL", "TN", "KY", 
                               "WV", "VA", "MD", "DE", "NC", "SC", "GA", "FL")),
         non_continental = (state %in% c( "HI", "AK"))) %>%
  
  mutate(region = ifelse(west == TRUE, "West", 
                         ifelse(midwest == TRUE, "Midwest", 
                                ifelse(northeast == TRUE, "Northeast", 
                                       ifelse(south == TRUE,  "South", 
                                              ifelse(non_continental == TRUE, "Non-continental                                                      US", "NA")))))) %>%
  
  mutate(city_size = ifelse(large_metro == TRUE, "Large Metropolitan", 
                         ifelse(metro == TRUE, "Metropolitan", 
                                ifelse(med_urban == TRUE, "Medium-Size Urban", 
                                       ifelse(small_urban == TRUE, 
                                              "Small-Size Urban", "NA"))))) %>%
  mutate(checkup_n = (population*(checkup/100)), 
         colon_n_screened = (population*(colon_screen/100)), 
         m_colorectal_n_screened = (population*(men_colorectal_cancer_screen/100)),
         w_colorectal_n_screened = 
           (population*(women_colorectal_cancer_screen/100)),
         mammogram_n_screened = (population*(mammogram/100)),
         pap_n_screened = (population*(pap_test/100))) %>%
  mutate(no_checkup_n = (population - checkup_n), 
         no_colon_n_screened = (population - colon_n_screened), 
         no_m_colorectal_n_screened = (population - m_colorectal_n_screened),
         no_w_colorectal_n_screened = 
           (population - w_colorectal_n_screened),
         no_mammogram_n_screened = (population - mammogram_n_screened),
         no_pap_n_screened = (population - pap_n_screened))

# checked the residual plot withouth this and need todo this to make model more accurate
set.seed(100);
model_west_cities <- sample(cities$city[cities$region == "West"], 25)
set.seed(100);
model_midwest_cities <- sample(cities$city[cities$region == "Midwest"], 25)
set.seed(100);
model_northeast_cities <- sample(cities$city[cities$region == "Northeast"], 25)
set.seed(100);
model_south_cities <- sample(cities$city[cities$region == "South"], 25)

model_cities_names <- c(model_west_cities, model_midwest_cities, 
                        model_northeast_cities, model_south_cities)

model_cities <- cities %>%
  filter(city %in% model_cities_names)

west_cities <- cities %>%
  filter(west)

midwest_cities <- cities %>%
  filter(midwest)

northeast_cities <- cities %>%
  filter(northeast)

south_cities <- cities %>%
  filter(south)

non_continental_cities <- cities %>% 
  filter(non_continental)

``` 

#boxplot of region and city size 

# Introductory Visualisations of Data Set

```{r Simple-Marginal-Relationship1, warning=FALSE, message=FALSE, echo=FALSE} 
 cities1 <- cities %>%
   na.omit(city_size)
#some rows had NA functions and it made a weird empty column in my ggplot so i got rid of it using above code 
ggplot(cities1, aes(x = city_size, 
                   y = checkup_n, 
                   fill = city_size))+ 
  geom_bar( stat = 'identity')+ 
  labs( x = "City Size", 
        y = "People who got a Checkup",
        title = "Number of Checkups by City Size") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))+ 
  theme(legend.position = "none")
#i did that last theme line bc i wanted to add some color 

#i kinda hate the y-axis numbers here because they are huge --- added options(scipen=10000) to the first code chunk to make this but i think there's a diff way to get rid of scientific notation that i cannot remember atm 
```

```{r Simple-Marginal-Relationship2, warning=FALSE, message=FALSE, echo=FALSE}
ggplot(cities, aes(x = health_access,
                   y= colon_screen))+
  geom_point()+ 
  labs( x = "Lack of Health Care Access", 
        y = "Number of People who got a Colon Screening",
        title = "Number of Checkups by City Size")
#want to find a way to organize by gender 
```

```{r Simple-Marginal-Relationship3, warning=FALSE, message=FALSE, echo=FALSE}
ggplot(cities, aes(x = health_access,
                   y= men_colorectal_cancer_screen))+
  geom_point()+ 
  labs( x = "Lack of Health Care Access", 
        y = "Men who had a Colorectal Cancer Screening ",
        title = "Colorectal Cancer Screening and Lack of Healthcare Access",
        subtitle = "Men only")
```

```{r Simple-Marginal-Relationship4, warning=FALSE, message=FALSE, echo=FALSE}
ggplot(cities, aes(x = health_access,
                   y= women_colorectal_cancer_screen))+
  geom_point()+ 
  labs( x = "Lack of Health Care Access", 
        y = "Women who had a Colorectal Cancer Screening ",
        title = "Colorectal Cancer Screening and Lack of Healthcare Access",
        subtitle = "Women only")
```

```{r Simple-Marginal-Relationship5, warning=FALSE, message=FALSE, echo=FALSE}
# cities2 <- cities %>% 
#   na.omit(region)
#why isn't my na.omit function working 
ggplot(cities, aes(x = region, 
                    y = mammogram_n_screened, 
                    fill = region))+
  geom_bar( stat = 'identity' )+ 
  labs( x = "Region", 
        y = "Women who had a Mammogram ",
        title = "Mammograms by Region") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))+
  theme(legend.position = "none")
#again added fill for some color for funsies 
```


```{r Predictor-Variable-Distribution, warning=FALSE, message=FALSE, echo=FALSE}

```


# Multiple Logistic Regression Model

```{r Checkup-Model, warning=FALSE, message=FALSE, echo=FALSE}

checkup_fit <- glm(cbind(checkup_n, no_checkup_n) ~ region + 
                     city_size + health_access, 
                   family = binomial, data = model_cities)
summary(checkup_fit)

checkup_fit_aug <-augment(checkup_fit)
ggplot(checkup_fit_aug, mapping = aes(x = .fitted, y = .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "blue", lty = "dashed") +
  labs(title = "Residual Plot", x = "Predicted Value", y = "Residuals")

#predict() VALIDATE DATA , TEST AND TRAINING SET
#first predict using model , calculate test error/mean square error 
#line and dot plot graph to compare test set with predicted model 

#can we just do checkup and say that this could be an indicator for general screening
```

# checkup_fit <- logistic_reg() %>%
#   set_engine("glm") %>%
#   fit(as.factor(checkup_n) ~ region + city_size + health_access, data=cities, 
#       family="binomial", exponentiate = TRUE)
# 
# result <- tidy(checkup_fit, conf.int=TRUE)
# print(result)

#how do i visualize all the log reg models 
can i augment when using a log reg model that uses cbind?
can i make a regression plot without using augment function?


```{r Colon_Model, warning=FALSE, message=FALSE, echo=FALSE}

colon_fit <- glm(cbind(colon_n_screened, no_colon_n_screened) ~ 
                   region + city_size + health_access, 
    family = binomial, data = model_cities)
summary(colon_fit)

```

```{r Mammogram_Model, warning=FALSE, message=FALSE, echo=FALSE}

mammogram_fit <- glm(cbind(mammogram_n_screened, no_mammogram_n_screened) ~ 
                   region + city_size + health_access, 
    family = binomial, data = model_cities)
summary(mammogram_fit)

```

```{r Pap_Model, warning=FALSE, message=FALSE, echo=FALSE}

pap_fit <- glm(cbind(pap_n_screened, no_pap_n_screened) ~ 
                   region + city_size + health_access, 
    family = binomial, data = model_cities)
summary(pap_fit)

```