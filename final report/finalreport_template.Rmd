---
title: "Final Report"
subtitle: "due November 16, 2021 by 11:59 PM "
author: "Enzo, Layla, Madeleine"
date: "November 16, 2021"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r load-packages-data, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(tidyr)
library(dplyr)
library(plyr)
library(tidymodels)
library(infer)
library(readr)
library(ggplot2)
library(maps)
library(mapdata)
library(sf)
library(plotly)
library(reshape)
initial_data <- read_csv("../data/500_Cities.csv")
options(scipen=10000)

usa <- map_data('usa')
state <- map_data("state")
```

```{r data-wrangling}
cities <- initial_data %>%
  select(StateAbbr, PlaceName, Population2010, PlaceFIPS, Geolocation, 
         ACCESS2_AdjPrev,CANCER_AdjPrev, CHD_AdjPrev, CHECKUP_AdjPrev,
         COPD_AdjPrev, COLON_SCREEN_AdjPrev,COREM_AdjPrev, COREW_AdjPrev, 
         KIDNEY_AdjPrev, MAMMOUSE_AdjPrev, PAPTEST_AdjPrev) %>%
  dplyr::rename(state = StateAbbr, city = PlaceName, population = Population2010,
         health_access = ACCESS2_AdjPrev, cancer = CANCER_AdjPrev,
         heart_disease = CHD_AdjPrev, checkup = CHECKUP_AdjPrev,
         chronic_lung_disease = COPD_AdjPrev,
         colon_screen = COLON_SCREEN_AdjPrev,
         men_colorectal_cancer_screen = COREM_AdjPrev,
         women_colorectal_cancer_screen = COREW_AdjPrev,
         chronic_kidney_disease = KIDNEY_AdjPrev,
         mammogram = MAMMOUSE_AdjPrev,
         pap_test = PAPTEST_AdjPrev) %>%
  mutate(large_metro = (population >= 1500000), 
         metro = (population >= 500000 & population < 1500000), 
         med_urban = (population >= 200000 & population < 500000), 
         small_urban = (population >= 50000 & population < 200000)) %>%
  mutate(west = (state %in% c("WA", "OR", "ID", "MT", "WY", "CA", "NV", "UT", 
                              "CO", "AZ", "NM")), 
         midwest = (state %in% c("ND", "SD", "NE", "KS", "MN", "IA", "MO", 
                                 "WI", "IL", "IN", "MI", "OH")),
         northeast = (state %in% c("PA", "NY", "VT", "NH", "MA", "CT", "RI", 
                                   "NJ", "ME", "DC")), 
         south = (state %in% c("OK", "TX", "AR", "LA", "MS", "AL", "TN", "KY", 
                               "WV", "VA", "MD", "DE", "NC", "SC", "GA", 
                               "FL"))) %>%
  mutate(region = ifelse(west == TRUE, "West", 
                         ifelse(midwest == TRUE, "Midwest", 
                                ifelse(northeast == TRUE, "Northeast", 
                                       ifelse(south == TRUE,  
                                              "South", NA))))) %>%
  mutate(city_size = ifelse(large_metro == TRUE, "Large Metropolitan", 
                         ifelse(metro == TRUE, "Metropolitan", 
                                ifelse(med_urban == TRUE, "Medium-Size Urban", 
                                       ifelse(small_urban == TRUE, 
                                              "Small-Size Urban", NA))))) %>%
  na.omit(city_size) %>%
  na.omit(region) %>%
  mutate(checkup_n = (population*(checkup/100)), 
         colon_n_screened = (population*(colon_screen/100)), 
         m_colorectal_n_screened = (population*(men_colorectal_cancer_screen/100)),
         w_colorectal_n_screened = 
           (population*(women_colorectal_cancer_screen/100)),
         mammogram_n_screened = (population*(mammogram/100)),
         pap_n_screened = (population*(pap_test/100))) %>%
  mutate(no_checkup_n = (population - checkup_n), 
         no_colon_n_screened = (population - colon_n_screened), 
         no_m_colorectal_n_screened = (population - m_colorectal_n_screened),
         no_w_colorectal_n_screened = 
           (population - w_colorectal_n_screened),
         no_mammogram_n_screened = (population - mammogram_n_screened),
         no_pap_n_screened = (population - pap_n_screened))

# checked the residual plot withouth this and need todo this to make model more accurate
#this is the training data set called model_cities
set.seed(100)

split <- initial_split(cities, prop = 3/4, strata = region)

model_cities <- training(split)
cities_test <- testing(split)

#for introductory visualizations
west_cities <- cities %>%
  filter(west)

midwest_cities <- cities %>%
  filter(midwest)

northeast_cities <- cities %>%
  filter(northeast)

south_cities <- cities %>%
  filter(south)

``` 

#boxplot of region and city size 

# Introductory Visualisations of Data Set

```{r enzo}

cities2 <- cities %>%
  filter( region != "NA") %>%
  mutate(logcheckup_n = log(checkup_n))

#boxplots of checkup (n and log) by region
ggplot(data = cities2,
       aes(x = region, y = logcheckup_n,
           color = region)) +
  geom_boxplot()

#anova shows means of checkup (n and log) are different among the regions
anova1 <- aov(logcheckup_n ~ region, data = cities2)
tidy(anova1)

#boxplots of checkup (n and log) by city size
ggplot(data = cities2,
       aes(x = city_size, y = logcheckup_n,
           color = city_size)) +
  geom_boxplot()

#anova shows means of checkup (n and log) are different among the city sizes
anova2 <- aov(logcheckup_n ~ city_size, data = cities2)
tidy(anova2)

#enzo's graph for health access vs checkup
ggplot(data = cities2,
       aes(x = health_access, y = logcheckup_n)) +
  geom_col(aes(width = 1))

#madeleine's graph for health access vs checkup
ggplot(cities, aes(x = health_access,
                   y= checkup))+
  geom_point()

```



```{r Simple-Marginal-Relationship1, warning=FALSE, message=FALSE, echo=FALSE} 
 cities1 <- cities %>%
   na.omit(city_size)
#some rows had NA functions and it made a weird empty column in my ggplot so i got rid of it using above code 
ggplot(cities1, aes(x = city_size, 
                   y = checkup_n, 
                   fill = city_size))+ 
  geom_bar( stat = 'identity')+ 
  labs( x = "City Size", 
        y = "People who got a Checkup",
        title = "Number of Checkups by City Size") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))+ 
  theme(legend.position = "none")
#i did that last theme line bc i wanted to add some color 

#i kinda hate the y-axis numbers here because they are huge --- added options(scipen=10000) to the first code chunk to make this but i think there's a diff way to get rid of scientific notation that i cannot remember atm 
```

```{r Simple-Marginal-Relationship2, warning=FALSE, message=FALSE, echo=FALSE}
ggplot(cities, aes(x = health_access,
                   y= colon_screen))+
  geom_point()+ 
  labs( x = "Lack of Health Care Access", 
        y = "Number of People who got a Colon Screening",
        title = "Number of Checkups by City Size")
#want to find a way to organize by gender 
```

```{r Simple-Marginal-Relationship3, warning=FALSE, message=FALSE, echo=FALSE}
ggplot(cities, aes(x = health_access,
                   y= men_colorectal_cancer_screen))+
  geom_point()+ 
  labs( x = "Lack of Health Care Access", 
        y = "Men who had a Colorectal Cancer Screening ",
        title = "Colorectal Cancer Screening and Lack of Healthcare Access",
        subtitle = "Men only")
```

```{r Simple-Marginal-Relationship4, warning=FALSE, message=FALSE, echo=FALSE}
ggplot(cities, aes(x = health_access,
                   y= women_colorectal_cancer_screen))+
  geom_point()+ 
  labs( x = "Lack of Health Care Access", 
        y = "Women who had a Colorectal Cancer Screening ",
        title = "Colorectal Cancer Screening and Lack of Healthcare Access",
        subtitle = "Women only")
```

```{r Simple-Marginal-Relationship5, warning=FALSE, message=FALSE, echo=FALSE}
# cities2 <- cities %>%
#   filter( region != "NA")
# why isn't my na.omit function working 
ggplot(cities, aes(x = region, 
                    y = mammogram_n_screened, 
                    fill = region))+
  geom_bar( stat = 'identity' )+ 
  labs( x = "Region", 
        y = "Women who had a Mammogram ",
        title = "Mammograms by Region") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))+
  theme(legend.position = "none")
#again added fill for some color for funsies 
```

```{r introvis-checkup6-region}
cities2 <- cities %>%
  filter( region != "NA")

ggplot(cities2, aes(x = region, 
                    y = checkup, 
                    color = region))+
  geom_bar( stat = 'identity' )+ 
  labs( x = "Region", 
        y = "Prevalence of checkup",
        title = "Prevalence of checkups by Region") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))+
  theme(legend.position = "none")
```

```{r introvis-checkup7-citysize}
cities2 <- cities %>%
  filter( city_size != "NA")

ggplot(cities2, aes(x = city_size, 
                    y = checkup, 
                    color = city_size))+
  geom_bar( stat = 'identity' )+ 
  labs( x = "Region", 
        y = "Prevalence of checkup",
        title = "Prevalence of checkups by City Size") +
  theme(axis.text.x = element_text(angle = 45,hjust=1))+
  theme(legend.position = "none")
#doesn't look that helpful tbh won't hurt my feelings if u trash it 
```

```{r introvis-checkup8-lackHC}
ggplot(cities, aes(x = health_access,
                   y= checkup))+
  geom_point()+ 
  labs( x = "Lack of Health Care Access", 
        y = "Prevalence of Checkups",
        title = "Prevalence of Checkups and Lack of Healthcare Access")
#cloud of points means something-- don't forget this later on 
```


```{r Predictor-Variable-Distribution, warning=FALSE, message=FALSE, echo=FALSE}
#fix this later 
ggplot(model_cities) +
  geom_boxplot(aes(region, city_size))

```

```{r Heatmap-Checkup-Screenings}

# cities_heatmap <- melt(cities, id.vars = "checkup", measure.vars = 
#                          c("colon_screen", "mammogram", "pap_test"))

#head(cities_heatmap)
# ggplot(cities, aes(checkup, )) +
  

correlation1 <- cor.test(cities$checkup_n, cities$pap_n_screened,
                         method = "pearson")
correlation2 <- cor.test(cities$checkup_n, cities$colon_n_screened,
                         method = "pearson")
correlation3 <- cor.test(cities$checkup_n, cities$mammogram_n_screened,
                         method = "pearson")
print(correlation1)
print(correlation2)
print(correlation3)

```


# Multiple Logistic Regression Model

```{r Checkup-Model, warning=FALSE, message=FALSE, echo=FALSE}

checkup_fit <- glm(cbind(checkup_n, no_checkup_n) ~ region + 
                     city_size + health_access, 
                   family = binomial, data = model_cities)
summary(checkup_fit)

#interaction model
checkup_fit2 <- glm(cbind(checkup_n, no_checkup_n) ~ region + 
                     city_size + health_access + region*city_size, 
                   family = binomial, data = model_cities)
summary(checkup_fit2)



#predict() VALIDATE DATA , TEST AND TRAINING SET
#first predict using model , calculate test error/mean square error 
#line and dot plot graph to compare test set with predicted model 

#can we just do checkup and say that this could be an indicator for general screening
```

# checkup_fit <- logistic_reg() %>%
#   set_engine("glm") %>%
#   fit(as.factor(checkup_n) ~ region + city_size + health_access, data=cities, 
#       family="binomial", exponentiate = TRUE)
# 
# result <- tidy(checkup_fit, conf.int=TRUE)
# print(result)

#how do i visualize all the log reg models 
can i augment when using a log reg model that uses cbind?
can i make a regression plot without using augment function?


```{r Colon_Model, warning=FALSE, message=FALSE, echo=FALSE}

colon_fit <- glm(cbind(colon_n_screened, no_colon_n_screened) ~ 
                   region + city_size + health_access, 
    family = binomial, data = model_cities)
summary(colon_fit)

```

```{r Mammogram_Model, warning=FALSE, message=FALSE, echo=FALSE}

mammogram_fit <- glm(cbind(mammogram_n_screened, no_mammogram_n_screened) ~ 
                   region + city_size + health_access, 
    family = binomial, data = model_cities)
summary(mammogram_fit)

```

```{r Pap_Model, warning=FALSE, message=FALSE, echo=FALSE}

pap_fit <- glm(cbind(pap_n_screened, no_pap_n_screened) ~ 
                   region + city_size + health_access, 
    family = binomial, data = model_cities)
summary(pap_fit)

```

# Model Validation
model that was made from the training data set compared to the rest of the test data points from the cities data
```{r Prediction}

library(pROC)

# predictions from no interaction model 

test_prob1 = predict(checkup_fit, newdata = cities_test, type = "response")
print(test_prob1)

new_cities_test <-
  merge(cities_test, test_prob1, by = "row.names", all.x = TRUE)

ggplot(cities_test, aes(x = test_prob1, y = checkup)) +
  geom_point()

# prediction from model with interaction

test_prob2 = predict(checkup_fit2, newdata = cities_test, type = "response")
print(test_prob2)

new_cities_test <-
  merge(cities_test, test_prob2, by = "row.names", all.x = TRUE)

ggplot(cities_test, aes(x = test_prob2, y = checkup)) +
  geom_point()

#calculate root mean standard error of both models

rmse(new_cities_test, truth = checkup, estimate = test_prob1)
rmse(new_cities_test, truth = checkup, estimate = test_prob2)

```

